.\" chuwi-minibook-x-daemon(8) manual page
.\" Copyright (c) 2025 Armando DiCianno <armando@noonshy.com>
.\" Licensed under GPL-2.0
.\"
.TH CHUWI-MINIBOOK-X-DAEMON 8 "November 2025" "1.0" "System Administration"
.SH NAME
chuwi-minibook-x-daemon \- userspace accelerometer feeder for Chuwi Minibook X
tablet mode detection
.SH SYNOPSIS
.B chuwi-minibook-x-daemon
.RI [ OPTIONS ]
.SH DESCRIPTION
.B chuwi-minibook-x-daemon
is a userspace daemon that feeds real-time accelerometer data to the Chuwi
Minibook X kernel module for tablet mode detection. The daemon reads from IIO
(Industrial I/O) accelerometer devices and performs 3D vector calculations to
determine hinge angles and device orientation.
.PP
The daemon operates in an event-driven manner using IIO triggers rather than
polling, ensuring efficient CPU usage while providing responsive tablet mode
detection.
.SH ARCHITECTURE
The daemon implements a sophisticated pipeline:
.IP 1. 4
Reads device assignments automatically from the kernel module
.IP 2. 4
Creates or reuses persistent IIO sysfs triggers for event-driven sampling
.IP 3. 4
Sets up IIO buffer-based data collection for both accelerometers
.IP 4. 4
Performs real-time 3D vector mathematics for hinge angle calculation
.IP 5. 4
Writes gravity vectors, mode, and orientation to kernel module sysfs interface
.IP 6. 4
Triggers immediate tablet mode evaluation in the kernel
.SH OPTIONS
.TP
.BR \-t ", " \-\-timeout\-ms " " \fIMS\fR
Set buffer read timeout in milliseconds for the poll() system call (default:
100). This is
.I not
a sampling rate - the daemon uses event-driven IIO triggers. The timeout
ensures the daemon remains responsive even if triggers fail.
.TP
.BR \-s ", " \-\-sysfs\-path " " \fIPATH\fR
Override the kernel module sysfs base path (default:
/sys/devices/platform/chuwi-minibook-x)
.TP
.BR \-d ", " \-\-daemon
Fork to background and run as a daemon process
.TP
.BR \-v ", " \-\-verbose
Enable verbose logging including real-time accelerometer readings, vector
calculations, and hinge angle computations
.TP
.BR \-h ", " \-\-help
Display usage information and exit
.TP
.BR \-V ", " \-\-version
Display version information and exit
.SH CONFIGURATION FILE
The daemon reads configuration from
.I /etc/default/chuwi-minibook-x-daemon
at startup. This file uses shell variable syntax and supports the following
variables:
.TP
.B BUFFER_TIMEOUT_MS
Buffer read timeout in milliseconds (equivalent to
.B \-\-timeout\-ms
option). Valid range: 1-10000. Higher values reduce CPU usage when idle but
may decrease responsiveness if IIO triggers fail.
.TP
.B SYSFS_PATH
Override the kernel module sysfs base path (equivalent to
.B \-\-sysfs\-path
option).
.TP
.B VERBOSE
Enable verbose logging if set to any non-empty value (equivalent to
.B \-\-verbose
option).
.TP
.B DAEMON
Run as background daemon if set to any non-empty value (equivalent to
.B \-\-daemon
option).
.PP
Device assignments are automatically detected from the kernel module and do
not require manual configuration.
.PP
Example configuration:
.nf
.RS
# Faster response time
BUFFER_TIMEOUT_MS=50

# Enable detailed logging
VERBOSE=1

# Run as daemon
DAEMON=1
.RE
.fi
.SH SYSTEMD SERVICE
The daemon is designed to run as a systemd service using the provided
.I chuwi-minibook-x-daemon.service
unit file. The service configuration includes:
.TP
.B Type=exec
Simple executable service type for reliable process management
.TP
.B Restart=on-failure
Automatic restart on unexpected failures with 5-second delay
.TP
.B Security Features
NoNewPrivileges, PrivateTmp, ProtectSystem=strict, and other hardening
options
.TP
.B Dependencies
Waits for IIO subsystem and kernel module availability
.PP
Service management commands:
.nf
.RS
# Start the service
sudo systemctl start chuwi-minibook-x-daemon

# Enable automatic startup
sudo systemctl enable chuwi-minibook-x-daemon

# Check service status
sudo systemctl status chuwi-minibook-x-daemon

# View service logs
sudo journalctl -u chuwi-minibook-x-daemon -f
.RE
.fi
.SH DEVICE DETECTION
The daemon automatically detects accelerometer devices through the kernel
module interface:
.IP \(bu 4
Base (keyboard) accelerometer device read from
.I /sys/devices/platform/chuwi-minibook-x/iio_base_device
.IP \(bu 4
Lid (screen) accelerometer device read from
.I /sys/devices/platform/chuwi-minibook-x/iio_lid_device
.IP \(bu 4
No manual device enumeration or configuration required
.IP \(bu 4
Mount matrix transformations handled automatically by IIO subsystem
.SH IIO TRIGGER MANAGEMENT
The daemon uses a simplified trigger management approach optimized for system
services:
.IP \(bu 4
Creates persistent sysfs trigger (sysfstrig0) on first run if none exists
.IP \(bu 4
Reuses existing triggers on subsequent runs for efficiency
.IP \(bu 4
Triggers persist after daemon shutdown, reducing system overhead
.IP \(bu 4
No complex lifecycle management - relies on systemd for service control
.IP \(bu 4
Event-driven sampling eliminates continuous polling overhead
.SH HINGE ANGLE CALCULATION
The daemon implements sophisticated 3D vector mathematics:
.TP
.B Data Collection
Reads raw accelerometer data via IIO buffer system with automatic scaling
.TP
.B Orientation Detection
Analyzes acceleration magnitudes to determine device orientation and select
appropriate projection plane (X-Z or Y-Z)
.TP
.B Vector Processing
Normalizes gravity vectors and projects them onto the selected plane
.TP
.B Angle Calculation
Uses dot product and cross product operations to compute hinge angle with
proper quadrant handling
.TP
.B Mode Determination
Applies configurable angle thresholds to determine laptop vs tablet mode
.TP
.B Orientation Mapping
Maps device orientation to standard platform orientation codes (landscape,
portrait, etc.)
.SH KERNEL INTERFACE
The daemon communicates with the kernel module through sysfs files:
.TP
.I /sys/devices/platform/chuwi-minibook-x/base_vec
Base accelerometer gravity vector (written by daemon)
.TP
.I /sys/devices/platform/chuwi-minibook-x/lid_vec
Lid accelerometer gravity vector (written by daemon)
.TP
.I /sys/devices/platform/chuwi-minibook-x/mode
Current device mode: "laptop" or "tablet" (written by daemon)
.TP
.I /sys/devices/platform/chuwi-minibook-x/orientation
Current screen orientation: "landscape", "portrait", etc. (written by daemon)
.TP
.I /sys/devices/platform/chuwi-minibook-x/iio_base_device
Base accelerometer device assignment (read by daemon)
.TP
.I /sys/devices/platform/chuwi-minibook-x/iio_lid_device
Lid accelerometer device assignment (read by daemon)
.SH TROUBLESHOOTING
.SS Service Issues
Check service status and logs:
.nf
.RS
sudo systemctl status chuwi-minibook-x-daemon
sudo journalctl -u chuwi-minibook-x-daemon --since "10 minutes ago"
.RE
.fi
.SS Manual Testing
Run the daemon manually with verbose output:
.nf
.RS
sudo chuwi-minibook-x-daemon --verbose
.RE
.fi
.SS Kernel Module Issues
Verify kernel module is loaded and functional:
.nf
.RS
# Check module is loaded
lsmod | grep chuwi

# Verify sysfs interface
ls -la /sys/devices/platform/chuwi-minibook-x/

# Check device assignments
cat /sys/devices/platform/chuwi-minibook-x/iio_base_device
cat /sys/devices/platform/chuwi-minibook-x/iio_lid_device
.RE
.fi
.SS IIO Device Issues
Verify accelerometer devices are available:
.nf
.RS
# List IIO devices
ls /sys/bus/iio/devices/

# Check for MXC4005 accelerometers
for dev in /sys/bus/iio/devices/iio:device*/name; do
    echo "$dev: $(cat "$dev" 2>/dev/null)"
done

# Verify IIO triggers
ls /sys/bus/iio/devices/trigger*
.RE
.fi
.SS Real-time Monitoring
Monitor daemon output and kernel interface:
.nf
.RS
# Watch mode changes
watch -n 0.1 'cat /sys/devices/platform/chuwi-minibook-x/mode'

# Monitor hinge angle (verbose daemon output)
sudo chuwi-minibook-x-daemon --verbose | grep "Hinge angle"
.RE
.fi
.SH FILES
.TP
.I /usr/sbin/chuwi-minibook-x-daemon
Main daemon executable
.TP
.I /etc/default/chuwi-minibook-x-daemon
Configuration file with environment variables
.TP
.I /etc/systemd/system/chuwi-minibook-x-daemon.service
Systemd service unit file
.TP
.I /sys/devices/platform/chuwi-minibook-x/
Kernel module sysfs interface directory
.TP
.I /sys/bus/iio/devices/trigger*
IIO sysfs triggers created and used by the daemon
.TP
.I /sys/bus/iio/devices/iio:device*/
IIO accelerometer device interfaces
.SH DEPENDENCIES
.TP
.B Kernel Modules
chuwi-minibook-x kernel module providing sysfs interface
.TP
.B IIO Subsystem
Linux Industrial I/O framework with MXC4005 accelerometer support
.TP
.B Hardware
Two MXC4005 accelerometers (base and lid) with proper mount matrix
configuration
.TP
.B Privileges
Root access required for IIO device and kernel module sysfs access
.TP
.B System Libraries
Standard C library with math library support
.SH SECURITY
The daemon is designed with security best practices:
.IP \(bu 4
Runs with minimal necessary privileges (root required for hardware access)
.IP \(bu 4
Systemd service includes security hardening (NoNewPrivileges, PrivateTmp,
etc.)
.IP \(bu 4
Input validation on all configuration values and device paths
.IP \(bu 4
Safe string handling throughout codebase
.IP \(bu 4
Minimal attack surface with no network connectivity
.SH PERFORMANCE
The event-driven architecture provides excellent performance characteristics:
.IP \(bu 4
CPU usage near zero when device is stationary
.IP \(bu 4
Immediate response to physical device movement
.IP \(bu 4
No continuous polling overhead
.IP \(bu 4
Efficient IIO buffer-based data collection
.IP \(bu 4
Persistent trigger reuse across daemon restarts
.SH LIMITATIONS
.IP \(bu 4
Requires root privileges for hardware access
.IP \(bu 4
Depends on proper accelerometer mount matrix configuration
.IP \(bu 4
Hinge angle accuracy limited by accelerometer precision and calibration
.IP \(bu 4
Single-instance operation enforced by systemd (no manual instance management)
.SH EXIT STATUS
.TP
.B 0
Successful operation or clean shutdown
.TP
.B 1
Initialization failure, configuration error, or runtime error
.SH EXAMPLES
.SS Basic Usage
Start the daemon manually with default settings:
.nf
.RS
sudo chuwi-minibook-x-daemon
.RE
.fi
.SS Debug Mode
Run with verbose logging for troubleshooting:
.nf
.RS
sudo chuwi-minibook-x-daemon --verbose
.RE
.fi
.SS Custom Timeout
Run with faster buffer timeout for increased responsiveness:
.nf
.RS
sudo chuwi-minibook-x-daemon --timeout-ms 25 --verbose
.RE
.fi
.SS Service Management
Manage via systemd (recommended):
.nf
.RS
sudo systemctl start chuwi-minibook-x-daemon
sudo systemctl enable chuwi-minibook-x-daemon
.RE
.fi
.SH SEE ALSO
.BR systemctl (1),
.BR journalctl (1),
.BR systemd.service (5),
.BR iio_generic_buffer (1)
.SH BUGS
Report bugs to the project issue tracker or contact the author.
.SH AUTHOR
Armando DiCianno <armando@noonshy.com>
.SH COPYRIGHT
Copyright (c) 2025 Armando DiCianno. Licensed under GPL-2.0.
.PP
This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
