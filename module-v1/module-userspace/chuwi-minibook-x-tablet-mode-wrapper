#!/usr/bin/env bash
set -euo pipefail

ENV_FILE="/etc/default/chuwi-minibook-x-tablet-mode"
[[ -r "$ENV_FILE" ]] && . "$ENV_FILE"

BASE_IIO="${BASE_IIO:-iio:device0}"
LID_IIO="${LID_IIO:-iio:device1}"
POLL_MS="${POLL_MS:-100}"

SYSFS_DIR="/sys/kernel/chuwi-minibook-x-tablet-mode"

# Wait for our kernel module sysfs and both IIO devices
wait_for() {
  local path=$1; local tries=60
  while [[ ! -e "$path" && $tries -gt 0 ]]; do
    sleep 0.5; tries=$((tries-1))
  done
  [[ -e "$path" ]]
}

# auto-pick two mxc4005 devices if BASE/LID not present
autopick_iio() {
  # pick first two IIO devices whose name is mxc4005
  mapfile -t devs < <(for n in /sys/bus/iio/devices/iio:device*/name; do
    if [[ -r "$n" ]] && grep -qi '^mxc4005$' "$n"; then
      dirname "$n" | xargs -I{} basename {}
    fi
  done)
  if (( ${#devs[@]} >= 2 )); then
    BASE_IIO="${devs[0]}"
    LID_IIO="${devs[1]}"
  fi
}

# If the configured devices don't exist, try to auto-pick
[[ ! -e "/sys/bus/iio/devices/$BASE_IIO" || ! -e "/sys/bus/iio/devices/$LID_IIO" ]] && autopick_iio

# Final wait loops
wait_for "$SYSFS_DIR/base_vec" || { echo "tablet-mode sysfs not found: $SYSFS_DIR"; exit 1; }
wait_for "/sys/bus/iio/devices/$BASE_IIO/in_accel_x_raw" || { echo "IIO base not ready: $BASE_IIO"; exit 1; }
wait_for "/sys/bus/iio/devices/$LID_IIO/in_accel_x_raw"  || { echo "IIO lid not ready: $LID_IIO"; exit 1; }

exec /usr/libexec/chuwi-minibook-x-tablet-mode/chuwi-minibook-x-tablet-mode "$BASE_IIO" "$LID_IIO" "$POLL_MS"
