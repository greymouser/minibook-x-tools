.\" Man page for chuwi-minibook-x-tablet-mode
.\" Copyright (c) 2025 Armando DiCianno <armando@noonshy.com>
.\" Licensed under GPL-2.0
.\"
.TH CHUWI-MINIBOOK-X-TABLET-MODE 8 "October 2025" "1.0" "System Administration"
.SH NAME
chuwi-minibook-x-tablet-mode \- userspace feeder for Chuwi Minibook X tablet mode detection
.SH SYNOPSIS
.B chuwi-minibook-x-tablet-mode
.RI [ OPTIONS ]
.SH DESCRIPTION
.B chuwi-minibook-x-tablet-mode
is a userspace daemon that reads accelerometer data from IIO (Industrial I/O) devices and feeds it to the Chuwi Minibook X tablet mode detection kernel module. The program continuously polls two accelerometer devices (base and lid) and writes the scaled vector data to the kernel module's sysfs interface for hinge angle calculation and tablet mode detection.

The daemon is designed to run as a system service and automatically detects MXC4005 accelerometer devices. It provides robust error handling, signal management, and extensive configuration options for production deployment.
.SH OPTIONS
.TP
.BR \-b ", " \-\-base\-device =\fIDEV\fR
Specify the base (keyboard) accelerometer device name.
.br
Default: \fIiio:device0\fR
.br
Example: \fB\-b iio:device0\fR
.TP
.BR \-l ", " \-\-lid\-device =\fIDEV\fR
Specify the lid (screen) accelerometer device name.
.br
Default: \fIiio:device1\fR
.br
Example: \fB\-l iio:device1\fR
.TP
.BR \-p ", " \-\-poll\-ms =\fIMS\fR
Set the polling interval in milliseconds. Must be between 1 and 10000.
.br
Default: \fI100\fR ms
.br
Example: \fB\-p 50\fR
.TP
.BR \-s ", " \-\-sysfs\-path =\fIPATH\fR
Specify the kernel module sysfs base path.
.br
Default: \fI/sys/kernel/chuwi-minibook-x-tablet-mode\fR
.br
Example: \fB\-s /sys/kernel/custom-tablet-mode\fR
.TP
.BR \-d ", " \-\-daemon
Run in daemon mode (background operation).
.TP
.BR \-v ", " \-\-verbose
Enable verbose logging with detailed debug information.
.TP
.BR \-h ", " \-\-help
Display help information and exit.
.TP
.BR \-V ", " \-\-version
Display version information and exit.
.SH CONFIGURATION
The daemon can be configured through command-line options or a configuration file. When run as a systemd service, configuration is typically provided via the environment file.
.SS Configuration File
The systemd service reads configuration from:
.br
.I /etc/default/chuwi-minibook-x-tablet-mode

Example configuration:
.nf
# Base accelerometer device
BASE_IIO=iio:device0

# Lid accelerometer device  
LID_IIO=iio:device1

# Polling interval in milliseconds
POLL_MS=100
.fi
.SS Device Detection
The companion wrapper script
.BR chuwi-minibook-x-tablet-mode-wrapper (8)
automatically detects MXC4005 accelerometer devices if the configured devices are not available. This provides automatic hardware detection for standard Chuwi Minibook X configurations.
.SH OPERATION
The daemon performs the following operations in a continuous loop:
.IP 1. 4
Read raw accelerometer values (x, y, z) from both devices
.IP 2. 4
Read scale factors from the IIO devices (if available)
.IP 3. 4
Apply scaling to convert raw values to standard units (micro-g)
.IP 4. 4
Write scaled vectors to kernel module sysfs interface:
.RS 8
.I /sys/kernel/chuwi-minibook-x-tablet-mode/base_vec
.br
.I /sys/kernel/chuwi-minibook-x-tablet-mode/lid_vec
.RE
.IP 5. 4
Sleep for the configured polling interval
.PP
The kernel module uses this data to calculate hinge angles and determine tablet mode state, generating appropriate input events for desktop environments.
.SH ERROR HANDLING
The daemon includes comprehensive error handling:
.TP
.B Device Detection
Validates that IIO devices exist and are readable before starting
.TP
.B Read Errors
Implements exponential backoff on consecutive read failures
.TP
.B Write Errors
Detects kernel module availability and sysfs accessibility
.TP
.B Signal Handling
Gracefully shuts down on SIGTERM and SIGINT
.TP
.B Resource Management
Prevents file handle leaks and ensures proper cleanup
.SH FILES
.TP
.I /usr/sbin/chuwi-minibook-x-tablet-mode
Main daemon executable
.TP
.I /usr/sbin/chuwi-minibook-x-tablet-mode-wrapper
Wrapper script with automatic device detection
.TP
.I /etc/default/chuwi-minibook-x-tablet-mode
Configuration file for systemd service
.TP
.I /usr/lib/systemd/system/chuwi-minibook-x-tablet-mode.service
Systemd service unit file
.TP
.I /sys/bus/iio/devices/iio:device*/
IIO device sysfs interfaces for accelerometers
.TP
.I /sys/kernel/chuwi-minibook-x-tablet-mode/
Kernel module sysfs interface
.SH EXAMPLES
.SS Manual Operation
Run with default settings:
.nf
.B chuwi-minibook-x-tablet-mode
.fi

Run with custom devices and verbose logging:
.nf
.B chuwi-minibook-x-tablet-mode -b iio:device2 -l iio:device3 -v
.fi

Run with faster polling (50ms interval):
.nf
.B chuwi-minibook-x-tablet-mode -p 50
.fi
.SS System Service
Enable and start the service:
.nf
.B sudo systemctl enable chuwi-minibook-x-tablet-mode
.B sudo systemctl start chuwi-minibook-x-tablet-mode
.fi

Check service status:
.nf
.B sudo systemctl status chuwi-minibook-x-tablet-mode
.fi

View service logs:
.nf
.B sudo journalctl -u chuwi-minibook-x-tablet-mode -f
.fi
.SH DIAGNOSTICS
.SS Troubleshooting
Use the validation script to diagnose issues:
.nf
.B validate-config.sh --verbose
.fi

Check available IIO devices:
.nf
.B ls /sys/bus/iio/devices/
.fi

Verify accelerometer data:
.nf
.B cat /sys/bus/iio/devices/iio:device0/in_accel_x_raw
.fi

Test kernel module interface:
.nf
.B ls -la /sys/kernel/chuwi-minibook-x-tablet-mode/
.fi
.SS Common Issues
.TP
.B "No IIO devices found"
Ensure the mxc4005 driver is loaded:
.B lsmod | grep mxc4005
.TP
.B "Kernel module sysfs not available"  
Load the kernel module:
.B sudo modprobe chuwi-minibook-x-tablet-mode
.TP
.B "Permission denied writing to sysfs"
Check that the service is running with appropriate permissions
.TP
.B "High CPU usage"
Increase the polling interval with
.B -p
option
.SH SECURITY
The daemon implements several security measures:
.IP \(bu 4
Input validation prevents buffer overflows
.IP \(bu 4
Runs with minimal privileges when used as systemd service
.IP \(bu 4
Restricted filesystem access via systemd sandboxing
.IP \(bu 4
Proper signal handling prevents data corruption
.IP \(bu 4
Resource limits prevent denial of service
.SH EXIT STATUS
.TP
.B 0
Successful operation or clean shutdown
.TP
.B 1
Configuration error, device not found, or operational failure
.SH SIGNALS
.TP
.B SIGTERM, SIGINT
Graceful shutdown - stops polling loop and exits cleanly
.TP
.B SIGHUP
Reserved for configuration reload (not currently implemented)
.TP
.B SIGPIPE
Ignored to prevent crashes on broken pipe errors
.SH SEE ALSO
.BR chuwi-minibook-x-tablet-mode-wrapper (8),
.BR systemctl (1),
.BR journalctl (1),
.BR modprobe (8)
.PP
Project documentation:
.I https://github.com/greymouser/minibook-x-tools
.SH DEPENDENCIES
.IP \(bu 4
Linux kernel with IIO subsystem support
.IP \(bu 4
MXC4005 accelerometer driver (CONFIG_MXC4005)
.IP \(bu 4
Chuwi Minibook X tablet mode kernel module
.IP \(bu 4
Two functional MXC4005 accelerometer devices
.SH HARDWARE
This daemon is specifically designed for the Chuwi Minibook X laptop, which features:
.IP \(bu 4
Intel processor with integrated sensors
.IP \(bu 4
Two MXC4005 accelerometers (base and lid)
.IP \(bu 4
360-degree hinge mechanism
.IP \(bu 4
Convertible laptop/tablet form factor
.SH BUGS
Report bugs to the project issue tracker or contact the author.
.PP
Known limitations:
.IP \(bu 4
Requires specific hardware configuration (MXC4005 devices)
.IP \(bu 4
Polling-based operation may introduce latency
.IP \(bu 4
Configuration reload requires service restart
.SH AUTHOR
Armando DiCianno <armando@noonshy.com>
.SH COPYRIGHT
Copyright (c) 2025 Armando DiCianno. Licensed under GPL-2.0.
.PP
This is free software; see the source for copying conditions. There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.